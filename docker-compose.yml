version: '2'
services:
  mdr:
    build:
      context: externals/dh-mdr
      dockerfile: Dockerfile
      args:
        - ENV_FILEBEAT_VERSION
        - ENV_RULE_WRAPPER_VERSION
        - SSL_ENV=${RIT_ENV}            # Whether to add our own CA-certificate to the CA-rootstore
    image: ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/mdr:${ENV_TAG}
    depends_on:
      - keycloak
      - mdr-db
    env_file:
      - irods.secrets.cfg # Using ONLY BIOPORTAL_API_KEY
    environment:
      VIRTUAL_HOST: mdr.${RIT_ENV}.dh.unimaas.nl
      VIRTUAL_PORT: 8000
      LOGSPOUT: ignore
      DJANGO_DEV_MODE: "True"   # dev: "True", acc/prod: "False"
      DJANGO_SECRET_KEY: foobar
      SAML_IDP_METADATA_URL: http://keycloak.${RIT_ENV}.dh.unimaas.nl:8080/auth/realms/django/protocol/saml/descriptor
      SAML_DJANGO_BASE_URL: http://mdr.${RIT_ENV}.dh.unimaas.nl
      SAML_DJANGO_WANT_ASSERTIONS_SIGNED: "True"                               # SURFconext: True, SRAM: False
      SAML_DJANGO_WANT_RESPONSE_SIGNED: "False"                                # SURFconext: True, SRAM: True
      # Must use friendly names here (not the urn:oid values, as those are being translated by pysaml2 already)
      SAML_DJANGO_USERNAME_ATTR: uid
      SAML_DJANGO_FIRSTNAME_ATTR: givenName
      SAML_DJANGO_LASTNAME_ATTR: sn
      SAML_DJANGO_MAIL_ATTR: mail
      IRODS_HOST: irods.dh.local
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_CLIENT_SERVER_POLICY: CS_NEG_REQUIRE
      DH_MAILER_HOST: mailer.dh.local
      DH_MAILER_TO_ADDRESS: m.coonen@maastrichtuniversity.nl
      DH_MAILER_USERNAME: user
      DH_MAILER_PASSWORD: password
      DISQOVER_URL: https://disqover.datahubmaastricht.nl/
      MDR_ANSIBLE_VERSION_TAG: DEV
      CROSSREF_LOOKUP_HOST: http://crossref-lookup.dh.local
      BIOPORTAL_URL: https://data.bioontology.org
      WEBDAV_URL: webdav.${RIT_ENV}.dh.unimaas.nl
      WEBDAV_UPLOAD_URL: upload.${RIT_ENV}.dh.unimaas.nl
      SMB_UM_WINDOWS_PATH: \\foobar.unimaas.nl\iRODS-ingestzones\dev
      SMB_UM_UNIX_PATH: foobar.unimaas.nl/iRODS-ingestzones/dev
      SMB_MUMC_WINDOWS_PATH: \\foobar.prd.corp\dev
      SMB_MUMC_UNIX_PATH: foobar.prd.corp/dev
      TERMS_OF_SERVICE_TIMESTAMP: 1618476699 #  date '+%s' on	Thu Apr 15 2021 08:51:39 GMT+0000
      DATAVERSE_ENDPOINT: https://demo.dataverse.nl/
      DATAVERSE_TREE_ROOT_ID: maastricht
      DATAVERSE_TREE_TITLE_FILTER: "DataHub;Maastricht UMC+;Faculty of Health, Medicine and Life Sciences;MERLN"
      RABBITMQ_HOST: rabbitmq.dh.local
      RABBITMQ_USER: user
      RABBITMQ_PASS: password
      RABBITMQ_PORT: 5672
      CACHE_TTL_VALUE: 86400 # in seconds => 24 hours
      MDR_POSTGRES_HOST: mdr-db.dh.local
      MDR_POSTGRES_DB: mdr
      MDR_POSTGRES_USER: postgres
      MDR_POSTGRES_PASSWORD: foobar
    volumes:
      - static_content:/opt/staticfiles
      # This volume bind gets the code that is in your rule-wrapper local repository and adds it to MDR. This allows 
      # for PyCharm to auto-reload when you edit the irods-rule-wrapper code locally.
      # If you want to use the irods-rule-wrapper code provided by the "ENV_RULE_WRAPPER_VERSION" variable in the .env file of this repository,
      # comment the following line.
      - ./externals/irods-rule-wrapper:/opt/src/irods-rule-wrapper
      - ./externals/dh-python-irods-utils/dhpythonirodsutils:/usr/local/lib/python3.10/site-packages/dhpythonirodsutils
    networks:
      default:
        aliases:
          - mdr.dh.local
      common_default:
        aliases:
          - mdr.dh.local
  dh-faker:
    build:
      context: externals/dh-faker
      dockerfile: docker/Dockerfile
      args:
        - SSL_ENV=${RIT_ENV}
    volumes:
      - ./externals/dh-faker:/opt/
      - ./staging-data:/mnt/ingest
    command: "python -c pass"
    environment:
      IRODS_HOST: irods.dh.local
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_CLIENT_SERVER_POLICY: CS_NEG_REQUIRE
      RABBITMQ_HOST: rabbitmq.dh.local
      RABBITMQ_USER: user
      RABBITMQ_PASS: password
      RABBITMQ_PORT: 5672
      LOG_LEVEL: INFO
    networks:
      default:
        aliases:
          - faker.dh.local
      common_default:
        aliases:
          - faker.dh.local
  keycloak:
    build:
      context: keycloak
      dockerfile: Dockerfile
    hostname: keycloak
    environment:
      VIRTUAL_HOST: keycloak.${RIT_ENV}.dh.unimaas.nl
      VIRTUAL_PORT: 8080
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: admin
      RIT_ENV: ${RIT_ENV}
      LDAP_ADMIN_PASSWORD: "admin"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./keycloak/realm-export.json:/tmp/realm-export.json
      - ./keycloak/users.json:/tmp/users.json
      - ./keycloak/groups.json:/tmp/groups.json
      - ./keycloak/import.sh:/tmp/import.sh
      - ./keycloak/startup.sh:/opt/jboss/startup-scripts/startup.sh
      - ./keycloak/datahub-keycloak-theme:/opt/jboss/keycloak/themes/datahub
    ports:
      # TODO: Find a better way to support both mdr->keycloak container traffic and browser->keycloak client traffic
      - "8080:8080"   # In order to bypass nginx-virtual-proxy while being redirected during Saml logins
    depends_on:
      - ldap
    networks:
      default:
        aliases:
          - keycloak.dh.local
          - keycloak.${RIT_ENV}.dh.unimaas.nl   # having this alias lets the mdr-container connect to the keycloak metadata URL
      common_default:
        aliases:
          - keycloak.dh.local
  ldap:
    image: osixia/openldap:1.3.0
    hostname: ldap
    environment:
      LDAP_ORGANISATION: "DataHub Maastricht"
      LDAP_DOMAIN: "datahubmaastricht.nl"
      LDAP_BASE_DN: ""
      LDAP_ADMIN_PASSWORD: "admin"
      LOGSTASH_TAGS: LDAP
    command: [--copy-service]
    ports:
      - "389:389"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./ldap/ldif_custom:/container/service/slapd/assets/config/bootstrap/ldif/custom/
    networks:
      default:
        aliases:
          - ldap.dh.local
  irods:
    build:
      context: icat/
      args:
        - ENV_POSTGRES_VERSION
        - ENV_IRODS_VERSION
        - ENV_IRODS_EXT_CLANG_VERSION
        - ENV_IRODS_EXT_CLANG_RUNTIME_VERSION
        - ENV_FILEBEAT_VERSION
    image:  ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/irods:${ENV_TAG}
    depends_on:
      - irods-db
    hostname: irods.dh.local
    ports:
      - "1247:1247"
      - "1248:1248"
    environment:
      RODS_PASSWORD: irods
      PGPASSWORD: foobar
      VIRTUAL_HOST: irods.${RIT_ENV}.rit.unimaas.nl
      IRODS_INGEST_REMOVE_DELAY: ${ENV_IRODS_INGEST_REMOVE_DELAY}
      EPICPID_URL: ${ENV_EPICPID_URL}
      EPICPID_USER: ${ENV_EPICPID_USER}
      EPICPID_PASSWORD: ${ENV_EPICPID_PASSWORD}
      MDR_HANDLE_URL: http://mdr.${RIT_ENV}.dh.unimaas.nl/hdl/
      LOGSPOUT: ignore  #ignore, because logs are forwarded by filebeat (in production it's not in a docker container)
    networks:
      default:
        aliases:
          - irods.dh.local
      common_default:
        aliases:
          - irods.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/irods-ruleset:/rules
      - ./externals/irods-microservices:/microservices
      - ./keycloak/users.json:/opt/irods/users.json

  ires:
    build:
      context: ires/
      args:
        - ENV_IRODS_VERSION
        - ENV_IRODS_EXT_CLANG_VERSION
        - ENV_IRODS_EXT_CLANG_RUNTIME_VERSION
        - ENV_DOCKERIZE_VERSION
        - ENV_FILEBEAT_VERSION
    image:  ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/ires:${ENV_TAG}
    depends_on:
      - irods
    hostname: ires.dh.local
    environment:
      RODS_PASSWORD: irods
      VIRTUAL_HOST: ires.${RIT_ENV}.rit.unimaas.nl
      IRODS_INGEST_REMOVE_DELAY: ${ENV_IRODS_INGEST_REMOVE_DELAY}
      EPICPID_URL: ${ENV_EPICPID_URL}
      EPICPID_USER: ${ENV_EPICPID_USER}
      EPICPID_PASSWORD: ${ENV_EPICPID_PASSWORD}
      MDR_HANDLE_URL: http://mdr.${RIT_ENV}.dh.unimaas.nl/hdl/
      LOGSPOUT: ignore  #ignore, because logs are forwarded by filebeat (in production it's not in a docker container)
    networks:
      default:
        aliases:
          - ires.dh.local
      common_default:
        aliases:
          - ires.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./irods.secrets.cfg:/etc/secrets:ro
      - ./externals/irods-ruleset:/rules
      - ./externals/irods-microservices:/microservices
      - ./externals/irods-helper-cmd:/helpers
      - ./staging-data:/mnt/ingest            # binding a non-existing dir results in creation of that dir on host system
    # Required for CIFS mounting. cap-add not enough in Windows for some reason.
    privileged: true
  ires-centos:
    build:
      context: ires-centos/
      args:
        - ENV_IRODS_VERSION
        - ENV_IRODS_EXT_CLANG_VERSION
        - ENV_IRODS_EXT_CLANG_RUNTIME_VERSION
        - ENV_DOCKERIZE_VERSION
        - ENV_FILEBEAT_VERSION
    image:  ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/ires-centos:${ENV_TAG}
    depends_on:
      - irods
    hostname: ires-centos.dh.local
    environment:
      RODS_PASSWORD: irods
      VIRTUAL_HOST: ires-centos.${RIT_ENV}.rit.unimaas.nl
      IRODS_INGEST_REMOVE_DELAY: ${ENV_IRODS_INGEST_REMOVE_DELAY}
      EPICPID_URL: ${ENV_EPICPID_URL}
      EPICPID_USER: ${ENV_EPICPID_USER}
      EPICPID_PASSWORD: ${ENV_EPICPID_PASSWORD}
      MDR_HANDLE_URL: http://mdr.${RIT_ENV}.dh.unimaas.nl/hdl/
      LOGSPOUT: ignore  #ignore, because logs are forwarded by filebeat (in production it's not in a docker container)
    networks:
      default:
        aliases:
          - ires-centos.dh.local
      common_default:
        aliases:
          - ires-centos.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./irods.secrets.cfg:/etc/secrets:ro
      - ./externals/irods-ruleset:/rules
      - ./externals/irods-microservices:/microservices
      - ./externals/irods-helper-cmd:/helpers
      - ./staging-data:/mnt/ingest            # binding a non-existing dir results in creation of that dir on host system
    # Required for CIFS mounting. cap-add not enough in Windows for some reason.
    privileged: true
  ires-s3-1:
    build:
      context: ires-s3/
      args:
        - ENV_IRODS_VERSION
        - ENV_IRODS_EXT_CLANG_VERSION
        - ENV_IRODS_EXT_CLANG_RUNTIME_VERSION
        - ENV_IRODS_RESC_PLUGIN_S3_VERSION
        - ENV_DOCKERIZE_VERSION
        - ENV_FILEBEAT_VERSION
    image:  ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/ires-s3:${ENV_TAG}
    depends_on:
      - irods
      - ires  # Because of ingest resource
      - minio1
    hostname: ires-s3-1.dh.local
    environment:
      RODS_PASSWORD: irods
      VIRTUAL_HOST: ires-s3-1.${RIT_ENV}.rit.unimaas.nl
      IRODS_INGEST_REMOVE_DELAY: ${ENV_IRODS_INGEST_REMOVE_DELAY}
      EPICPID_URL: ${ENV_EPICPID_URL}
      EPICPID_USER: ${ENV_EPICPID_USER}
      EPICPID_PASSWORD: ${ENV_EPICPID_PASSWORD}
      MDR_HANDLE_URL: http://mdr.${RIT_ENV}.dh.unimaas.nl/hdl/
      LOGSPOUT: ignore  #ignore, because logs are forwarded by filebeat (in production it's not in a docker container)
      ENV_S3_ACCESS_KEY: ${ENV_S3_ACCESS_KEY1}
      ENV_S3_SECRET_KEY: ${ENV_S3_SECRET_KEY1}
      ENV_S3_RESC_NAME: "UM-Ceph-S3-AC"
      ENV_S3_HOST: "minio1.dh.local:9000"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./irods.secrets.cfg:/etc/secrets:ro
      - ./externals/irods-ruleset:/rules
      - ./externals/irods-microservices:/microservices
      - ./externals/irods-helper-cmd:/helpers
    networks:
      default:
        aliases:
          - ires-s3-1.dh.local
      common_default:
        aliases:
          - ires-s3-1.dh.local
  ires-s3-2:
    build:
      context: ires-s3/
      args:
        - ENV_IRODS_VERSION
        - ENV_IRODS_EXT_CLANG_VERSION
        - ENV_IRODS_EXT_CLANG_RUNTIME_VERSION
        - ENV_IRODS_RESC_PLUGIN_S3_VERSION
        - ENV_DOCKERIZE_VERSION
        - ENV_FILEBEAT_VERSION
    image:  ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/ires-s3:${ENV_TAG}
    depends_on:
      - irods
      - ires  # Because of ingest resource
      - minio2
    hostname: ires-s3-2.dh.local
    environment:
      RODS_PASSWORD: irods
      VIRTUAL_HOST: ires-s3-2.${RIT_ENV}.rit.unimaas.nl
      IRODS_INGEST_REMOVE_DELAY: ${ENV_IRODS_INGEST_REMOVE_DELAY}
      EPICPID_URL: ${ENV_EPICPID_URL}
      EPICPID_USER: ${ENV_EPICPID_USER}
      EPICPID_PASSWORD: ${ENV_EPICPID_PASSWORD}
      MDR_HANDLE_URL: http://mdr.${RIT_ENV}.dh.unimaas.nl/hdl/
      LOGSPOUT: ignore  #ignore, because logs are forwarded by filebeat (in production it's not in a docker container)
      ENV_S3_ACCESS_KEY: ${ENV_S3_ACCESS_KEY2}
      ENV_S3_SECRET_KEY: ${ENV_S3_SECRET_KEY2}
      ENV_S3_RESC_NAME: "UM-Ceph-S3-GL"
      ENV_S3_HOST: "minio2.dh.local:9000"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./irods.secrets.cfg:/etc/secrets:ro
      - ./externals/irods-ruleset:/rules
      - ./externals/irods-microservices:/microservices
      - ./externals/irods-helper-cmd:/helpers
    networks:
      default:
        aliases:
          - ires-s3-2.dh.local
      common_default:
        aliases:
          - ires-s3-2.dh.local
  irods-db:
    image: postgres:${ENV_POSTGRES_VERSION}
    hostname: irods-db
    environment:
      POSTGRES_PASSWORD: foobar
      LOGSPOUT: ignore
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      default:
        aliases:
          - irods-db.dh.local
      common_default:
        aliases:
          - irods-db.dh.local
  irods-frontend:
    build:
      context: externals/irods-frontend/
      args:
        - ENV_IRODS_REST_VERSION
        - ENV_FILEBEAT_VERSION
        - SSL_ENV=${RIT_ENV}            # Whether to add our own CA-certificate to the CA-rootstore
    image:  ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/irods-frontend:${ENV_TAG}
    hostname: irods-frontend
    environment:
      VIRTUAL_HOST: frontend.${RIT_ENV}.rit.unimaas.nl
      # logs are sent via filebeat, so logspout should be ignored
      LOGSPOUT: ignore
    networks:
      default:
        aliases:
          - irods-frontend.dh.local
      common_default:
        aliases:
          - irods-frontend.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
  davrods:
    build:
      context: externals/rit-davrods/
      args:
        - ENV_DAVRODS_IRODS_VERSION
        - ENV_DAVRODS_VERSION
        - ENV_FILEBEAT_VERSION
        - SSL_ENV=${RIT_ENV}            # Whether to add our own CA-certificate to the CA-rootstore
        - VHOST_FILE=davrods-vhost.conf
        - FILEBEAT_CONFIG_FILE=filebeat.yml
    image:  ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/davrods:${ENV_TAG}
    depends_on:
      - irods
    environment:
      VIRTUAL_HOST: webdav.${RIT_ENV}.dh.unimaas.nl
      LOGSPOUT: ignore
    networks:
      default:
        aliases:
          - davrods.dh.local
      common_default:
        aliases:
          - davrods.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
  davrods-upload:
    build:
      context: externals/rit-davrods/
      args:
        - ENV_DAVRODS_IRODS_VERSION
        - ENV_DAVRODS_VERSION
        - ENV_FILEBEAT_VERSION
        - SSL_ENV=${RIT_ENV}            # Whether to add our own CA-certificate to the CA-rootstore
        - VHOST_FILE=upload-davrods-vhost.conf
        - FILEBEAT_CONFIG_FILE=filebeat-upload.yml
    image: ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/davrods-upload:${ENV_TAG}
    depends_on:
      - irods
    environment:
      VIRTUAL_HOST: upload.${RIT_ENV}.dh.unimaas.nl
      LOGSPOUT: ignore
    networks:
      default:
        aliases:
          - davrods-upload.dh.local
      common_default:
        aliases:
          - davrods-upload.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
  metalnx:
    image: irods/metalnx:${ENV_METALNX_VERSION}
    hostname: metalnx
    depends_on:
      - irods
      - metalnx-db
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/rit-metalnx-web/metalnx-configuration/metalnxConfig.xml:/etc/irods-ext/metalnxConfig.xml
      - ./externals/rit-metalnx-web/metalnx-configuration/metalnx.properties:/tmp/metalnx.properties
      - ./externals/rit-metalnx-web/log4j.properties:/tmp/log4j.properties
      - ./externals/rit-metalnx-web/ServerInfo.properties:/usr/local/tomcat/lib/org/apache/catalina/util/ServerInfo.properties
      - ./externals/rit-metalnx-web/runit.sh:/runit.sh
      - ./icat/SSL/test_only_dev_irods_dh_ca_cert.pem:/tmp/cert/server.crt
    environment:
      IRODS_HOST: irods.dh.local
      IRODS_PORT: 1247
      IRODS_ZONE: nlmumc
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_DEFAULT_RESC: rootResc
      METALNX_DB_URL: "jdbc:postgresql://metalnx-db.dh.local:5432/metalnxdb"
      METALNX_DB_USER: metalnxuser
      METALNX_DB_PASS: foobar
      VIRTUAL_HOST: metalnx.${RIT_ENV}.rit.unimaas.nl
      VIRTUAL_PORT: 8080
      LOGSTASH_TAGS: METALNX
    networks:
      default:
        aliases:
          - metalnx.dh.local
      common_default:
        aliases:
          - metalnx.dh.local
  metalnx-db:
    image: postgres:${ENV_METALNX_POSTGRES_VERSION}
    hostname: metalnx-db
    environment:
      POSTGRES_PASSWORD: foobar
      POSTGRES_USER: metalnxuser
      POSTGRES_DB: metalnxdb
    networks:
      default:
        aliases:
          - metalnx-db.dh.local
      common_default:
        aliases:
          - metalnx-db.dh.local
  crossref-lookup:
    build: externals/crossref-lookup
    image: ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/crossref-lookup:${ENV_TAG}
    environment:
      VIRTUAL_HOST: crossref-lookup.${RIT_ENV}.dh.unimaas.nl
      LOGSTASH_TAGS: CROSSREF_LOOKUP
    networks:
      default:
        aliases:
          - crossref-lookup.dh.local
      common_default:
        aliases:
          - crossref-lookup.dh.local
    volumes:
      - ./externals/crossref-lookup/app:/usr/src/app
      - /etc/localtime:/etc/localtime:ro
  epicpid:
    build: externals/epicpid-microservice/docker
    image: ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/epicpid:${ENV_TAG}
    environment:
      VIRTUAL_HOST: epicpid.${RIT_ENV}.dh.unimaas.nl
      LOGSTASH_TAGS: EPIC_PID
      LOG_LEVEL: DEBUG
      USERNAME: user
      PASSWORD: foobar
      RABBITMQ_HOST : rabbitmq.dh.local
      RABBITMQ_USER : user
      RABBITMQ_PASS : password
      RABBITMQ_PORT: 5672
      EPIC_CREDENTIALS: my_credentials_test.json
      REQUESTS_CA_BUNDLE: /opt/epic5storagesurfsaranlCHAIN.crt
    networks:
      default:
        aliases:
          - epicpid.dh.local
      common_default:
        aliases:
          - epicpid.dh.local
    volumes:
      - ./externals/epicpid-microservice/:/opt/app
      - /etc/localtime:/etc/localtime:ro
  minio1:
    image: minio/minio:RELEASE.2019-05-23T00-29-34Z
    environment:
      VIRTUAL_HOST: minio1.${RIT_ENV}.rit.unimaas.nl
      MINIO_ACCESS_KEY: ${ENV_S3_ACCESS_KEY1}
      MINIO_SECRET_KEY: ${ENV_S3_SECRET_KEY1}
    entrypoint: sh
    command: -c 'mkdir -p /data/dh-irods-bucket-dev && /usr/bin/minio server /data'
    networks:
      default:
        aliases:
          - minio1.dh.local
      common_default:
        aliases:
          - minio1.dh.local
  minio2:
    image: minio/minio:RELEASE.2019-05-23T00-29-34Z
    environment:
      VIRTUAL_HOST: minio2.${RIT_ENV}.rit.unimaas.nl
      MINIO_ACCESS_KEY: ${ENV_S3_ACCESS_KEY2}
      MINIO_SECRET_KEY: ${ENV_S3_SECRET_KEY2}
    entrypoint: sh
    command: -c 'mkdir -p /data/dh-irods-bucket-dev && /usr/bin/minio server /data'
    networks:
      default:
        aliases:
          - minio2.dh.local
      common_default:
        aliases:
          - minio2.dh.local
  open-access-worker:
    build:
      context: ./externals/irods-open-access-repo
      dockerfile: ./docker/Dockerfile
      args:
        - SSL_ENV=${RIT_ENV}
    image: ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/open-access-worker:${ENV_TAG}
#    depends_on:
#      - irods
    env_file:
      - irods.secrets.cfg # Using ONLY DATAVERSE_TOKEN
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: user
      RABBITMQ_PASS: password
      IRODS_HOST: irods.dh.local
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_CLIENT_SERVER_POLICY: CS_NEG_REQUIRE
      DATAVERSE_HOST: https://demo.dataverse.nl
      DH_MAILER_HOST: mailer.dh.local
      DH_MAILER_USERNAME: user
      DH_MAILER_PASSWORD: password
      LOG_LEVEL: INFO
      LOGSTASH_TAGS: OPEN_ACCESS_WORKER
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      default:
        aliases:
          - open-access-worker.dh.local
      common_default:
        aliases:
          - open-access-worker.dh.local
  sram-sync:
    build:
      context: externals/sram-sync/
      dockerfile: Dockerfile
      args:
        - SSL_ENV=${RIT_ENV}          # Whether to add our own CA-certificate to the CA-rootstore
    image: ${ENV_REGISTRY_HOST}/docker-dev/${ENV_BRANCH}/sram-sync:${ENV_TAG}
    depends_on:
      - irods
      - ldap
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/sram-sync/:/opt/app
    environment:
      LOG_LEVEL: INFO
      IRODS_HOST: irods.dh.local
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_CLIENT_SERVER_POLICY: CS_NEG_REQUIRE
      LDAP_USER: cn=admin,dc=datahubmaastricht,dc=nl
      LDAP_PASS: admin
      LDAP_HOST: ldap://ldap.dh.local
      LDAP_USERS_BASE_DN: ou=People,dc=flat,dc=datahubmaastricht,dc=nl
      LDAP_GROUPS_BASE_DN: ou=Groups,dc=flat,dc=datahubmaastricht,dc=nl
      LDAP_COS_BASE_DN:  dc=ordered,dc=datahubmaastricht,dc=nl
      DEFAULT_USER_PASSWORD: foobar
      LOGSTASH_TAGS: SRAMSYNC
      SYNC_USERS: "True"
      DELETE_USERS: "True"
      SYNC_GROUPS: "True"
      DELETE_GROUPS: "True"
    command: sram-sync.py --commit --scheduled
    networks:
      default:
      common_default:
  mdr-db:
    image: postgres:${ENV_MDR_POSTGRES_VERSION}
    hostname: mdr-db
    environment:
      POSTGRES_DB: mdr
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: foobar
      LOGSPOUT: ignore
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      default:
        aliases:
          - mdr-db.dh.local
      common_default:
        aliases:
          - mdr-db.dh.local


networks:
  common_default:
    external: true

volumes:
  static_content:
