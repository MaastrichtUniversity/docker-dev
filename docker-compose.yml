version: '2'

networks:
  ceph-cluster-net:
    ipam:
      driver: default
      config:
        - subnet: 172.18.0.0/24
          gateway: 172.18.0.1

services:
  irods:
    build:
      context: icat/
      args:
        ENV_IRODS_VERSION: ${ENV_IRODS_VERSION}
        ENV_IRODS_EXT_CLANG_VERSION: ${ENV_IRODS_EXT_CLANG_VERSION}
        ENV_IRODS_EXT_CLANG_RUNTIME_VERSION: ${ENV_IRODS_EXT_CLANG_RUNTIME_VERSION}
        ENV_CMAKE_VERSION: ${ENV_CMAKE_VERSION}
        ENV_CMAKE_LONG_VERSION: ${ENV_CMAKE_LONG_VERSION}
        ENV_FILEBEAT_VERSION: ${ENV_FILEBEAT_VERSION}
    hostname: irods
    ports:
      - "1247:1247"
      - "1248:1248"
    environment:
      RODS_PASSWORD: irods
      PGPASSWORD: foobar
      VIRTUAL_HOST: irods.${RIT_ENV}.rit.unimaas.nl
    networks:
      - default
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./irods.secrets.cfg:/etc/secrets:ro
  ires-ceph:
    build:
      context: ires-ceph/
      args:
        ENV_IRODS_VERSION: ${ENV_IRODS_VERSION}
        ENV_IRODS_EXT_CLANG_VERSION: ${ENV_IRODS_EXT_CLANG_VERSION}
        ENV_IRODS_EXT_CLANG_RUNTIME_VERSION: ${ENV_IRODS_EXT_CLANG_RUNTIME_VERSION}
        ENV_CMAKE_VERSION: ${ENV_CMAKE_VERSION}
        ENV_CMAKE_LONG_VERSION: ${ENV_CMAKE_LONG_VERSION}
        ENV_DOCKERIZE_VERSION: ${ENV_DOCKERIZE_VERSION}
    hostname: ires-ceph
    environment:
      RODS_PASSWORD: irods
      PGPASSWORD: foobar
      VIRTUAL_HOST: ires-ceph.${RIT_ENV}.rit.unimaas.nl
    networks:
      - default
      - ceph-cluster-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./irods.secrets.cfg:/etc/secrets:ro
      - ./externals/irods_resource_plugin_rados:/irods_resource_plugin_rados
      - ${VOLUMES_PATH}/ceph:/etc/ceph
  irods-db:
    image: postgres:${ENV_POSTGRES_VERSION}
    hostname: irods-db
    environment:
      POSTGRES_PASSWORD: foobar
    volumes:
      - /etc/localtime:/etc/localtime:ro

  mon1:
    build:
      context: mon1
      args:
        - CEPH_CONTAINER_VERSION
        - VOLUMES_PATH
        - DISKS_PATH
        - DASHBOARD_PORT
        - RGW_PORT
        - CEPH_PUBLIC_NETWORK
    command: "mon"
    environment:
      - MON_IP
      - CEPH_PUBLIC_NETWORK
    volumes:
      - ${VOLUMES_PATH}/ceph:/etc/ceph
      - ${VOLUMES_PATH}/lib/:/var/lib/ceph/
    networks:
      ceph-cluster-net:
        ipv4_address: ${MON_IP}

  mgr: 
    image: ceph/daemon:${CEPH_CONTAINER_VERSION}
    command: "mgr"
    volumes:
      - ${VOLUMES_PATH}/ceph:/etc/ceph
      - ${VOLUMES_PATH}/lib/:/var/lib/ceph/
    depends_on:
      - mon1
    networks: 
      - ceph-cluster-net
    ports:
      - ${DASHBOARD_PORT}:7000
  
  osd1:
    pid: host
    privileged: true
    image: ceph/daemon:${CEPH_CONTAINER_VERSION}
    command: "osd"
    volumes:
      - ${VOLUMES_PATH}/ceph:/etc/ceph
      - ${VOLUMES_PATH}/lib/:/var/lib/ceph/
      - /dev/:/dev/
    environment:
      OSD_DEVICE: ${OSD1_DEVICE}
      OSD_TYPE: disk
      OSD_FORCE_ZAP: 1
    depends_on:
      - mon1
    networks: 
      - ceph-cluster-net
  
  osd2:
    pid: host
    privileged: true
    image: ceph/daemon:${CEPH_CONTAINER_VERSION}
    command: "osd"
    volumes:
      - ${VOLUMES_PATH}/ceph:/etc/ceph
      - ${VOLUMES_PATH}/lib/:/var/lib/ceph/
      - /dev/:/dev/
    environment:
      OSD_DEVICE: ${OSD2_DEVICE}
      OSD_TYPE: disk
      OSD_FORCE_ZAP: 1
    depends_on:
      - mon1
    networks: 
      - ceph-cluster-net

  osd3:
    pid: host
    privileged: true
    image: ceph/daemon:${CEPH_CONTAINER_VERSION}
    command: "osd"
    volumes:
      - ${VOLUMES_PATH}/ceph:/etc/ceph
      - ${VOLUMES_PATH}/lib/:/var/lib/ceph/
      - /dev/:/dev/
    environment:
      OSD_DEVICE: ${OSD3_DEVICE}
      OSD_TYPE: disk
      OSD_FORCE_ZAP: 1
    depends_on:
      - mon1
    networks: 
      - ceph-cluster-net

  rgw1:
    image: ceph/daemon:${CEPH_CONTAINER_VERSION}
    command: "rgw"
    volumes:
      - ${VOLUMES_PATH}/ceph:/etc/ceph
      - ${VOLUMES_PATH}/lib/:/var/lib/ceph/
    depends_on:
      - osd1
      - osd2
      - osd3
    networks: 
      - ceph-cluster-net
    ports:
      - ${RGW_PORT}:8080
