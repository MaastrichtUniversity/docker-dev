version: '2'
services:
  mdr:
    build:
      context: externals/dh-mdr
      dockerfile: Dockerfile
      args:
        - ENV_FILEBEAT_VERSION
        - ENV_RULE_WRAPPER_VERSION
        - SSL_ENV=${RIT_ENV}            # Whether to add our own CA-certificate to the CA-rootstore
    image: ${ENV_REGISTRY_HOST}/docker-dev/mdr:${ENV_TAG}
    depends_on:
      - keycloak
      - mdr-db
    env_file:
      - irods.secrets.cfg
      - mdr.env
    volumes:
      - static_content:/opt/staticfiles
      # This volume bind gets the code that is in your rule-wrapper local repository and adds it to MDR. This allows 
      # for PyCharm to auto-reload when you edit the irods-rule-wrapper code locally.
      # If you want to use the irods-rule-wrapper code provided by the "ENV_RULE_WRAPPER_VERSION" variable in the .env file of this repository,
      # comment the following line.
      - ./externals/irods-rule-wrapper:/opt/src/irods-rule-wrapper
      - ./externals/dh-python-irods-utils/dhpythonirodsutils:/usr/local/lib/python3.10/site-packages/dhpythonirodsutils
    networks:
      default:
        aliases:
          - mdr.dh.local
      common_default:
        aliases:
          - mdr.dh.local
  elastic:
    build:
      context: externals/dh-elasticsearch
      dockerfile: Dockerfile
    image: ${ENV_REGISTRY_HOST}/docker-dev/elastic:${ENV_TAG}
    environment:
      ingest.geoip.downloader.enabled: "false"
      discovery.type: single-node
      ES_JAVA_OPTS: -Xms512m -Xmx512m
      ELASTIC_PASSWORD: ${ENV_ELASTIC_PASSWORD}
      xpack.security.enabled: "true"
      VIRTUAL_HOST: elastic.${RIT_ENV}.dh.unimaas.nl
      VIRTUAL_PORT: 9200
    volumes:
      - elastic_metadata:/usr/share/elasticsearch/data
    networks:
        default:
          aliases:
            - elastic.dh.local
        common_default:
          aliases:
            - elastic.dh.local
  dh-faker:
    build:
      context: externals/dh-faker
      dockerfile: docker/Dockerfile
      args:
        - SSL_ENV=${RIT_ENV}
    image: ${ENV_REGISTRY_HOST}/docker-dev/faker:${ENV_TAG}
    volumes:
      - ./externals/dh-faker:/opt/
      - ./staging-data:/mnt/ingest
    command: "python -c pass"
    environment:
      IRODS_HOST: icat.dh.local
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_CLIENT_SERVER_POLICY: CS_NEG_REQUIRE
      RABBITMQ_HOST: rabbitmq.dh.local
      RABBITMQ_USER: user
      RABBITMQ_PASS: password
      RABBITMQ_PORT: 5672
      LOG_LEVEL: INFO
    networks:
      default:
        aliases:
          - faker.dh.local
      common_default:
        aliases:
          - faker.dh.local
  keycloak:
    build:
      context: keycloak
      dockerfile: Dockerfile
    image: ${ENV_REGISTRY_HOST}/docker-dev/keycloak:${ENV_TAG}
    hostname: keycloak
    environment:
      VIRTUAL_HOST: keycloak.${RIT_ENV}.dh.unimaas.nl
      VIRTUAL_PORT: 8080
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: admin
      RIT_ENV: ${RIT_ENV}
      LDAP_ADMIN_PASSWORD: "admin"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./keycloak/realm-export.json:/tmp/realm-export.json
      - ./keycloak/users.json:/tmp/users.json
      - ./keycloak/groups.json:/tmp/groups.json
      - ./keycloak/import.sh:/tmp/import.sh
      - ./keycloak/startup.sh:/opt/jboss/startup-scripts/startup.sh
      - ./keycloak/datahub-keycloak-theme:/opt/jboss/keycloak/themes/datahub
    ports:
      # TODO: Find a better way to support both mdr->keycloak container traffic and browser->keycloak client traffic
      - "8080:8080"   # In order to bypass nginx-virtual-proxy while being redirected during Saml logins
    depends_on:
      - ldap
    networks:
      default:
        aliases:
          - keycloak.dh.local
          - keycloak.${RIT_ENV}.dh.unimaas.nl   # having this alias lets the mdr-container connect to the keycloak metadata URL
      common_default:
        aliases:
          - keycloak.dh.local
  ldap:
    image: osixia/openldap:1.3.0
    hostname: ldap
    environment:
      LDAP_ORGANISATION: "DataHub Maastricht"
      LDAP_DOMAIN: "datahubmaastricht.nl"
      LDAP_BASE_DN: ""
      LDAP_ADMIN_PASSWORD: "admin"
      LOGSTASH_TAGS: LDAP
    command: [--copy-service]
    ports:
      - "389:389"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./ldap/ldif_custom:/container/service/slapd/assets/config/bootstrap/ldif/custom/
    networks:
      default:
        aliases:
          - ldap.dh.local
  davrods:
    build:
      context: externals/rit-davrods/
      args:
        - ENV_DAVRODS_IRODS_VERSION
        - ENV_DAVRODS_VERSION
        - ENV_FILEBEAT_VERSION
        - SSL_ENV=${RIT_ENV}            # Whether to add our own CA-certificate to the CA-rootstore
        - VHOST_FILE=davrods-vhost.conf
        - FILEBEAT_CONFIG_FILE=filebeat.yml
    image:  ${ENV_REGISTRY_HOST}/docker-dev/davrods:${ENV_TAG}
    depends_on:
      - icat
    environment:
      VIRTUAL_HOST: download.${RIT_ENV}.dh.unimaas.nl
      LOGSPOUT: ignore
    networks:
      default:
        aliases:
          - davrods.dh.local
      common_default:
        aliases:
          - davrods.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - webdav_logs:/var/log
  davrods-upload:
    build:
      context: externals/rit-davrods/
      args:
        - ENV_DAVRODS_IRODS_VERSION
        - ENV_DAVRODS_VERSION
        - ENV_FILEBEAT_VERSION
        - SSL_ENV=${RIT_ENV}            # Whether to add our own CA-certificate to the CA-rootstore
        - VHOST_FILE=upload-davrods-vhost.conf
        - FILEBEAT_CONFIG_FILE=filebeat-upload.yml
    image: ${ENV_REGISTRY_HOST}/docker-dev/davrods-upload:${ENV_TAG}
    depends_on:
      - icat
    environment:
      VIRTUAL_HOST: upload.${RIT_ENV}.dh.unimaas.nl
      LOGSPOUT: ignore
    networks:
      default:
        aliases:
          - davrods-upload.dh.local
      common_default:
        aliases:
          - davrods-upload.dh.local
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - upload_logs:/var/log
  epicpid:
    build: externals/epicpid-microservice/docker
    image: ${ENV_REGISTRY_HOST}/docker-dev/epicpid:${ENV_TAG}
    environment:
      VIRTUAL_HOST: epicpid.${RIT_ENV}.dh.unimaas.nl
      LOGSTASH_TAGS: EPIC_PID
      LOG_LEVEL: DEBUG
      USERNAME: user
      PASSWORD: foobar
      RABBITMQ_HOST : rabbitmq.dh.local
      RABBITMQ_USER : user
      RABBITMQ_PASS : password
      RABBITMQ_PORT: 5672
      EPIC_CREDENTIALS: my_credentials_test.json
      REQUESTS_CA_BUNDLE: /opt/epic5storagesurfsaranlCHAIN.crt
    networks:
      default:
        aliases:
          - epicpid.dh.local
      common_default:
        aliases:
          - epicpid.dh.local
    volumes:
      - ./externals/epicpid-microservice/:/opt/app
      - /etc/localtime:/etc/localtime:ro
  open-access-worker:
    build:
      context: ./externals/irods-open-access-repo
      dockerfile: ./docker/Dockerfile
      args:
        - SSL_ENV=${RIT_ENV}
    image: ${ENV_REGISTRY_HOST}/docker-dev/open-access-worker:${ENV_TAG}
#    depends_on:
#      - irods
    env_file:
      - irods.secrets.cfg # Using ONLY DATAVERSE_TOKEN
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: user
      RABBITMQ_PASS: password
      IRODS_HOST: icat.dh.local
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_CLIENT_SERVER_POLICY: CS_NEG_REQUIRE
      DATAVERSE_HOST: https://demo.dataverse.nl
      DH_MAILER_HOST: mailer.dh.local
      DH_MAILER_USERNAME: user
      DH_MAILER_PASSWORD: password
      LOG_LEVEL: INFO
      LOGSTASH_TAGS: OPEN_ACCESS_WORKER
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      default:
        aliases:
          - open-access-worker.dh.local
      common_default:
        aliases:
          - open-access-worker.dh.local
  sram-sync:
    build:
      context: externals/sram-sync/
      dockerfile: Dockerfile
      args:
        - SSL_ENV=${RIT_ENV}          # Whether to add our own CA-certificate to the CA-rootstore
    image: ${ENV_REGISTRY_HOST}/docker-dev/sram-sync:${ENV_TAG}
    depends_on:
      - icat
      - ldap
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/sram-sync/:/opt/app
    environment:
      LOG_LEVEL: INFO
      IRODS_HOST: icat.dh.local
      IRODS_USER: rods
      IRODS_PASS: irods
      IRODS_CLIENT_SERVER_POLICY: CS_NEG_REQUIRE
      LDAP_USER: cn=admin,dc=datahubmaastricht,dc=nl
      LDAP_PASS: admin
      LDAP_HOST: ldap://ldap.dh.local
      LDAP_USERS_BASE_DN: ou=People,dc=flat,dc=datahubmaastricht,dc=nl
      LDAP_GROUPS_BASE_DN: ou=Groups,dc=flat,dc=datahubmaastricht,dc=nl
      LDAP_COS_BASE_DN:  dc=ordered,dc=datahubmaastricht,dc=nl
      DEFAULT_USER_PASSWORD: foobar
      LOGSTASH_TAGS: SRAMSYNC
      SYNC_USERS: "True"
      DELETE_USERS: "True"
      SYNC_GROUPS: "True"
      DELETE_GROUPS: "True"
    command: sram-sync.py --commit --scheduled
    networks:
      default:
      common_default:
  mdr-db:
    image: postgres:${ENV_MDR_POSTGRES_VERSION}
    hostname: mdr-db
    environment:
      POSTGRES_DB: mdr
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: foobar
      LOGSPOUT: ignore
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      default:
        aliases:
          - mdr-db.dh.local
      common_default:
        aliases:
          - mdr-db.dh.local

networks:
  common_default:
    external: true

volumes:
  static_content:
  webdav_logs:
  upload_logs:
  elastic_metadata:
